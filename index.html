<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ãŠã¿ãã˜ç®¡ç†</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ãŠã¿ãã˜">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#F2F2F7" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">

    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23FF3B30'/%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle' fill='white'%3Eâ›©ï¸%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23FF3B30'/%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle' fill='white'%3Eâ›©ï¸%3C/text%3E%3C/svg%3E">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- é…è‰²è¨­å®š --- */
        :root {
            --primary: #007AFF; --bg: #F2F2F7; --card-bg: #FFFFFF;
            --input-bg: #EFEFF4; --input-border: #C7C7CC;
            --text: #000000; --text-sub: #333333; --danger: #FF3B30;
            --gold: #FFD700; --silver: #C0C0C0; --bronze: #CD7F32;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        /* --- ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š --- */
        @font-face {
            font-family: 'GoshuinFont';
            src: url('goshuin.ttf') format('truetype');
        }

        [data-theme="dark"] {
            --primary: #0A84FF; --bg: #000000; --card-bg: #1C1C1E;
            --input-bg: #3A3A3C; --input-border: #636366; --text: #FFFFFF; --text-sub: #D1D1D6;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif; margin: 0; padding: 0;
            background-color: var(--bg); color: var(--text); font-size: 15px;
            padding-top: var(--safe-top); padding-bottom: calc(80px + var(--safe-bottom));
            overscroll-behavior-y: none;
        }

        header {
            background: var(--card-bg); padding: 12px 16px; position: sticky; top: 0;
            z-index: 100; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--input-border); height: 44px;
        }

        h1 { font-size: 17px; margin: 0; font-weight: 700; }
        .version-badge { font-size: 10px; background: var(--input-bg); padding: 2px 6px; border-radius: 4px; color: var(--text-sub); margin-left: 8px; vertical-align: middle; }

        .streak-container {
            background: linear-gradient(135deg, #FF9500 0%, #FF3B30 100%);
            color: white; padding: 12px; border-radius: 12px; margin: 10px 16px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .streak-count { font-size: 24px; font-weight: 800; }

        .container { width: 100%; padding: 0; }
        .card { background: var(--card-bg); padding: 16px; margin-bottom: 12px; border-bottom: 1px solid var(--input-border); }
        .form-group { margin-bottom: 16px; }
        label { display: block; font-size: 13px; font-weight: 700; color: var(--text-sub); margin-bottom: 6px; }

        /* å…¥åŠ›ã‚¹ã‚¿ã‚¤ãƒ« */
        input[type="text"], input[type="date"], select, textarea {
            width: 100%; padding: 12px; font-size: 16px; font-weight: 500;
            border: 1px solid var(--input-border); border-radius: 8px; box-sizing: border-box;
            background: var(--input-bg); color: var(--text); outline: none;
        }
        select {
            -webkit-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat; background-position: right 12px center; background-size: 14px;
        }

        button.btn-primary {
            display: block; width: 92%; margin: 10px auto; padding: 14px;
            background: var(--primary); color: white; border: none; border-radius: 10px;
            font-size: 16px; font-weight: 700; cursor: pointer;
        }

        .tabs { display: flex; background: var(--card-bg); padding: 8px; border-bottom: 1px solid var(--input-border); position: sticky; top: 68px; z-index: 90; }
        .tab { flex: 1; text-align: center; padding: 10px 4px; font-size: 13px; cursor: pointer; border-radius: 8px; color: var(--text-sub); font-weight: 700; }
        .tab.active { background: var(--bg); color: var(--primary); }

        .history-item { background: var(--card-bg); padding: 16px; border-bottom: 1px solid var(--input-border); margin-bottom: 1px; }
        .history-top { display: flex; justify-content: space-between; align-items: flex-start; }
        .fortune-badge { font-size: 14px; padding: 4px 12px; border-radius: 6px; font-weight: 700; border: 1px solid; }

        .action-row { display: flex; justify-content: flex-end; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
        .btn-small { padding: 6px 12px; font-size: 12px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--card-bg); color: var(--text); cursor: pointer; }
        .btn-goshuin { color: var(--primary); border-color: var(--primary); background: rgba(0,122,255,0.05); font-weight: bold; }
        .btn-delete { color: var(--danger); border-color: var(--danger); background: rgba(255,59,48,0.05); }

        /* åˆ†æã‚¿ãƒ–ç”¨ãƒˆã‚°ãƒ« */
        .chart-toggle-row { display: flex; gap: 10px; margin-bottom: 16px; }
        .toggle-btn { flex: 1; padding: 10px; font-size: 14px; border: 1px solid var(--input-border); background: var(--bg); color: var(--text-sub); border-radius: 8px; cursor: pointer; font-weight: 700; text-align: center; }
        .toggle-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .chart-container { position: relative; height: 350px; width: 100%; }

        /* ç§°å·ãƒªã‚¹ãƒˆï¼ˆãƒ¬ã‚¢ãƒªãƒ†ã‚£å¾©æ—§ï¼‰ */
        .badge-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; padding: 10px; }
        .badge-item { background: var(--card-bg); border: 2px solid var(--input-border); border-radius: 12px; padding: 10px; text-align: center; opacity: 0.4; filter: grayscale(100%); position: relative; }
        .badge-item.unlocked { opacity: 1; filter: grayscale(0%); background: linear-gradient(135deg, var(--card-bg) 0%, rgba(255,255,255,0.5) 100%); }
        .badge-rank-1.unlocked { border-color: var(--bronze); box-shadow: 0 2px 5px rgba(205,127,50,0.3); }
        .badge-rank-2.unlocked { border-color: var(--silver); box-shadow: 0 3px 8px rgba(192,192,192,0.4); }
        .badge-rank-3.unlocked { border-color: var(--gold); box-shadow: 0 4px 10px rgba(255,215,0,0.5); }
        .badge-rank-4.unlocked { border-color: var(--primary); box-shadow: 0 0 10px var(--primary); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 5px var(--primary); } 50% { box-shadow: 0 0 15px var(--primary); } 100% { box-shadow: 0 0 5px var(--primary); } }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-overlay.show { display: flex; }
        .modal-content { background: var(--card-bg); width: 90%; max-width: 400px; border-radius: 20px; padding: 20px; text-align: center; }
        .goshuin-preview { width: 100%; border-radius: 10px; margin-bottom: 15px; border: 1px solid #ccc; background: #fffcf2; }
        .hidden { display: none; }
        .rank-dai-kichi { color: #D32F2F; background: #FFEBEE; border-color: #D32F2F; }
    </style>
</head>
<body>

<header>
    <h1>â›©ï¸ ãŠã¿ãã˜<span class="version-badge">ver 4.2</span></h1>
    <button onclick="toggleTheme()" style="background:none; border:none; font-size:20px;">ğŸŒ—</button>
</header>

<div class="container">
    <div class="tabs">
        <div class="tab active" onclick="switchTab('input')">ğŸ–Šï¸ è¨˜éŒ²</div>
        <div class="tab" onclick="switchTab('history')">ğŸ“œ å±¥æ­´</div>
        <div class="tab" onclick="switchTab('analysis')">ğŸ“Š åˆ†æ</div>
        <div class="tab" onclick="switchTab('collection')">ğŸ† ç§°å·</div>
        <div class="tab" onclick="switchTab('settings')">âš™ï¸ è¨­å®š</div>
    </div>

    <div id="tab-input">
        <div class="streak-container">
            <div style="font-size:24px;">ğŸ”¥</div>
            <div>
                <div class="streak-count"><span id="streak-days">0</span>æ—¥</div>
                <div style="font-size:11px; font-weight:bold;">é€£ç¶šå‚æ‹ä¸­</div>
            </div>
        </div>
        <div class="card">
            <div class="form-group">
                <label>ğŸ‘¤ åå‰</label>
                <input type="text" id="input-name" placeholder="ä¾‹: è‡ªåˆ†" list="name-list" autocomplete="off">
                <datalist id="name-list"></datalist>
            </div>
            <div class="form-group">
                <label>ğŸ“… å‚æ‹æ—¥</label>
                <input type="date" id="input-date">
            </div>
            <div class="form-group">
                <label>â›©ï¸ ç¥ç¤¾å</label>
                <input type="text" id="input-shrine" placeholder="ä¾‹: æ˜æ²»ç¥å®®" list="shrine-list" autocomplete="off">
                <datalist id="shrine-list"></datalist>
            </div>
            <div class="form-group">
                <label>ğŸ”® é‹å‹¢</label>
                <select id="input-result">
                    <option value="å¤§å‰">å¤§å‰</option><option value="å‰">å‰</option><option value="ä¸­å‰">ä¸­å‰</option>
                    <option value="å°å‰">å°å‰</option><option value="æœ«å‰">æœ«å‰</option><option value="å‡¶">å‡¶</option><option value="å¤§å‡¶">å¤§å‡¶</option>
                </select>
            </div>
            <div class="form-group"><label>ğŸ“ ãƒ¡ãƒ¢</label><textarea id="input-note" rows="2"></textarea></div>
        </div>
        <button class="btn-primary" onclick="addEntry()">ğŸ’¾ è¨˜éŒ²ã‚’ä¿å­˜ï¼</button>
    </div>

    <div id="tab-history" class="hidden">
        <div id="history-list"></div>
    </div>

    <div id="tab-analysis" class="hidden">
        <div class="card">
            <h2 style="font-size:16px; margin-bottom:12px;">çµ±è¨ˆãƒ»åˆ†æ</h2>
            <div class="chart-toggle-row">
                <div id="toggle-luck" class="toggle-btn active" onclick="switchChartType('luck')">ğŸ”® é‹å‹¢</div>
                <div id="toggle-shrine" class="toggle-btn" onclick="switchChartType('shrine')">â›©ï¸ ç¥ç¤¾</div>
            </div>
            <div class="form-group">
                <label>ğŸ‘¥ è¡¨ç¤ºå¯¾è±¡</label>
                <select id="filter-person" onchange="updateChart()">
                    <option value="ALL">å…¨å“¡</option>
                </select>
            </div>
            <div class="chart-container"><canvas id="mainChart"></canvas></div>
            <p id="analysis-summary" style="text-align:center; margin-top:16px; font-size:14px; color:var(--text-sub);"></p>
        </div>
    </div>

    <div id="tab-collection" class="hidden">
        <div id="badge-container" class="badge-list"></div>
    </div>

    <div id="tab-settings" class="hidden">
        <div class="card">
            <h2 style="font-size:16px;">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
            <button class="btn-primary" onclick="exportData()">ğŸ“¤ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜ (DL)</button>
            <br>
            <button class="btn-primary" style="background:var(--silver); color:black;" onclick="triggerImport()">ğŸ“¥ å¾©å…ƒ (èª­ã¿è¾¼ã¿)</button>
            <input type="file" id="file-import" style="display:none" accept=".json" onchange="importData(this)">
            <br>
            <button class="btn-primary" style="background:var(--danger);" onclick="clearAllData()">âš ï¸ ãƒ‡ãƒ¼ã‚¿å…¨æ¶ˆå»</button>
        </div>
    </div>
</div>

<div id="goshuin-modal" class="modal-overlay" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3 style="margin-top:0;">â›©ï¸ å¾¡æœ±å°ä½œæˆ</h3>
        <canvas id="goshuin-canvas" width="300" height="450" class="goshuin-preview"></canvas>
        <div style="display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">
            <button class="btn-primary" style="width:auto; margin:0;" onclick="downloadGoshuin()">ğŸ’¾ ç”»åƒä¿å­˜</button>
            <button class="btn-primary" style="width:auto; background:#34C759; margin:0;" onclick="shareImage()">ğŸ“¤ ç”»åƒã‚·ã‚§ã‚¢</button>
            <button class="btn-small" onclick="redrawGoshuin()">ğŸ”„ å†æç”»</button>
        </div>
    </div>
</div>

<script>
    const STORAGE_KEY = 'omikuji_app_data_v1';
    let entries = [];
    let currentGoshuinEntry = null;
    let myChart = null;
    let currentChartType = 'luck'; // 'luck' or 'shrine'

    // --- â˜…å®Œå…¨ç‰ˆï¼šç§°å·ãƒ‡ãƒ¼ã‚¿ãƒªã‚¹ãƒˆ (å…¨ç¨®å¾©æ´») ---
    const BADGES = [
        { id: 'f1', name: 'åˆã‚ã®ä¸€æ­©', icon: 'ğŸ£', desc: 'åˆã‚ã¦è¨˜éŒ²ã—ãŸ', rank: 1, check: (d) => d.length >= 1 },
        { id: 'f10', name: 'å‚æ‹æ„›å¥½å®¶', icon: 'ğŸš¶', desc: 'è¨˜éŒ²ãŒ10å›', rank: 1, check: (d) => d.length >= 10 },
        { id: 'f30', name: 'ç¥ä¸»è¦‹ç¿’ã„', icon: 'â›©ï¸', desc: 'è¨˜éŒ²ãŒ30å›', rank: 2, check: (d) => d.length >= 30 },
        { id: 'f50', name: 'ç¥ã®ä½¿ã„', icon: 'ğŸ§š', desc: 'è¨˜éŒ²ãŒ50å›', rank: 3, check: (d) => d.length >= 50 },
        { id: 'f100', name: 'ç”Ÿãã‚‹ä¼èª¬', icon: 'ğŸ²', desc: 'è¨˜éŒ²ãŒ100å›', rank: 4, check: (d) => d.length >= 100 },
        { id: 'ohakudo', name: 'ãŠç™¾åº¦å‚ã‚Š', icon: 'ğŸ™', desc: 'ä¸€äººã®è¨˜éŒ²ãŒ100å›', rank: 4, check: (d) => { 
            const counts = {}; d.forEach(e => { const n = e.name || 'è‡ªåˆ†'; counts[n] = (counts[n] || 0) + 1; });
            return Object.values(counts).some(c => c >= 100);
        }},
        { id: 'l1', name: 'å°ã•ãªå¹¸ã›', icon: 'âœ¨', desc: 'å¤§å‰ã‚’1å›', rank: 1, check: (d) => d.some(e => e.result === 'å¤§å‰') },
        { id: 'l5', name: 'å¼·é‹ã®æŒã¡ä¸»', icon: 'ğŸŒŸ', desc: 'å¤§å‰ã‚’5å›', rank: 2, check: (d) => d.filter(e => e.result === 'å¤§å‰').length >= 5 },
        { id: 'l10', name: 'å¤§å‰ãƒãƒ³ã‚¿ãƒ¼', icon: 'ğŸ‘‘', desc: 'å¤§å‰ã‚’10å›', rank: 3, check: (d) => d.filter(e => e.result === 'å¤§å‰').length >= 10 },
        { id: 'lucky3', name: 'ç¢ºå¤‰ãƒ¢ãƒ¼ãƒ‰', icon: 'ğŸ°', desc: '3å›é€£ç¶šã§å¤§å‰', rank: 3, check: (d) => {
            if(d.length < 3) return false;
            const s = [...d].sort((a,b)=>new Date(b.date)-new Date(a.date));
            return s[0].result==='å¤§å‰'&&s[1].result==='å¤§å‰'&&s[2].result==='å¤§å‰';
        }},
        { id: 'bad1', name: 'å„é™¤ã‘å¤§å¸«', icon: 'ğŸ›¡ï¸', desc: 'å‡¶/å¤§å‡¶ã‚’å¼•ã', rank: 1, check: (d) => d.some(e => ['å‡¶','å¤§å‡¶'].includes(e.result)) },
        { id: 'bad5', name: 'ä¸å±ˆã®ç²¾ç¥', icon: 'â¤ï¸â€ğŸ”¥', desc: 'å‡¶/å¤§å‡¶ã‚’5å›', rank: 2, check: (d) => d.filter(e => ['å‡¶','å¤§å‡¶'].includes(e.result)).length >= 5 },
        { id: 'bad2combo', name: 'æ³£ãã£é¢ã«èœ‚', icon: 'â˜”', desc: '2é€£ç¶šã§å‡¶/å¤§å‡¶', rank: 1, check: (d) => hasConsecutiveResult(d, ['å‡¶','å¤§å‡¶'], 2) },
        { id: 'vrecovery', name: 'æ˜‡ã‚Šèª¿å­', icon: 'ğŸ“ˆ', desc: 'å¤§å‡¶ã®ç›´å¾Œã«å¤§å‰', rank: 2, check: (d) => {
            if(d.length < 2) return false;
            const s = [...d].sort((a,b)=>new Date(a.date)-new Date(b.date));
            for(let i=0; i<s.length-1; i++) if(s[i].result==='å¤§å‡¶' && s[i+1].result==='å¤§å‰') return true;
            return false;
        }},
        { id: 'roller', name: 'æ€¥è»¢ç›´ä¸‹', icon: 'ğŸ¢', desc: 'å¤§å‰ã¨å¤§å‡¶ãŒé€£ç¶š', rank: 2, check: (d) => {
            if(d.length < 2) return false;
            const s = [...d].sort((a,b)=>new Date(a.date)-new Date(b.date));
            for(let i=0; i<s.length-1; i++) {
                const r1 = s[i].result, r2 = s[i+1].result;
                if((r1==='å¤§å‰'&&r2==='å¤§å‡¶') || (r1==='å¤§å‡¶'&&r2==='å¤§å‰')) return true;
            }
            return false;
        }},
        { id: 'normal5', name: 'THEãƒ»å‡¡äºº', icon: 'ğŸµ', desc: 'å‰ãƒ»ä¸­ãƒ»å°ã‚’5é€£ç¶š', rank: 1, check: (d) => hasConsecutiveResult(d, ['å‰','ä¸­å‰','å°å‰'], 5) },
        { id: 'alltypes', name: 'é‹å‘½ã®è’é›†å®¶', icon: 'ğŸŒˆ', desc: 'å…¨é‹å‹¢ã‚³ãƒ³ãƒ—', rank: 4, check: (d) => {
            const types = ['å¤§å‰','å‰','ä¸­å‰','å°å‰','æœ«å‰','å‡¶','å¤§å‡¶'];
            const my = new Set(d.map(e => e.result));
            return types.every(t => my.has(t));
        }},
        { id: 'newyear', name: 'ã‚ã‘ãŠã‚ï¼', icon: 'ğŸ', desc: 'ä¸‰ãŒæ—¥ã«å‚æ‹', rank: 2, check: (d) => d.some(e => { const dt = new Date(e.date); return dt.getMonth()===0 && dt.getDate()<=3; }) },
        { id: 'summer', name: 'å¤ã®æ€ã„å‡º', icon: 'ğŸŒ»', desc: '8æœˆã«å‚æ‹', rank: 1, check: (d) => d.some(e => new Date(e.date).getMonth()===7) },
        { id: 'endyear', name: 'å¹´è¶Šã—è©£', icon: 'ğŸ””', desc: 'å¤§æ™¦æ—¥ã«å‚æ‹', rank: 2, check: (d) => d.some(e => { const dt = new Date(e.date); return dt.getMonth()===11 && dt.getDate()===31; }) },
        { id: 'monthly', name: 'æœˆå‚ã‚Šã®é”äºº', icon: 'ğŸŒ™', desc: '12ãƒ¶æœˆå…¨ã¦ã§è¨˜éŒ²', rank: 4, check: (d) => {
            const m = new Set(d.map(e => new Date(e.date).getMonth())); return m.size === 12;
        }},
        { id: 'weekend', name: 'é€±æœ«ã®ç¥ä¸»', icon: 'ğŸ»', desc: 'åœŸæ—¥å‚æ‹10å›', rank: 2, check: (d) => {
            return d.filter(e => { const w = new Date(e.date).getDay(); return w===0||w===6; }).length >= 10;
        }},
        { id: 'lucky7', name: 'ãƒ©ãƒƒã‚­ãƒ¼ã‚»ãƒ–ãƒ³', icon: '7ï¸âƒ£', desc: '7ã®ã¤ãæ—¥7å›', rank: 3, check: (d) => {
            return d.filter(e => { const dd = new Date(e.date).getDate(); return dd===7||dd===17||dd===27; }).length >= 7;
        }},
        { id: 'combo3', name: 'ä¸‰æ—¥åŠä¸»å’æ¥­', icon: 'ğŸ”¥', desc: '3æ—¥é€£ç¶šå‚æ‹', rank: 2, check: (d) => hasConsecutiveDays(d, 3) },
        { id: 'combo7', name: 'ç¿’æ…£ã®é¬¼', icon: 'ğŸ‘¹', desc: '7æ—¥é€£ç¶šå‚æ‹', rank: 3, check: (d) => hasConsecutiveDays(d, 7) },
        { id: 'traveler', name: 'ç¥ç¤¾å·¡ã‚Š', icon: 'ğŸ—ºï¸', desc: '5ç®‡æ‰€ã®ç¥ç¤¾', rank: 2, check: (d) => new Set(d.map(e => e.shrine)).size >= 5 },
        { id: 'explorer', name: 'è–åœ°é–‹æ‹“è€…', icon: 'ğŸ§­', desc: '10ç®‡æ‰€ã®ç¥ç¤¾', rank: 3, check: (d) => new Set(d.map(e => e.shrine)).size >= 10 },
        { id: 'single', name: 'ä¸€é€”ãªæƒ³ã„', icon: 'ğŸ’˜', desc: 'åŒã˜ç¥ç¤¾5é€£ç¶š', rank: 1, check: (d) => {
            if(d.length<5) return false;
            const s = [...d].sort((a,b)=>new Date(b.date)-new Date(a.date));
            let c=1; for(let i=0;i<s.length-1;i++) { if(s[i].shrine===s[i+1].shrine) c++; else c=1; if(c>=5) return true; }
            return false;
        }},
        { id: 's_jingu', name: 'ç¥å®®ãƒãƒ‹ã‚¢', icon: 'ğŸ¯', desc: 'ã€Œç¥å®®ã€ã¸è¡Œã', rank: 1, check: (d) => d.some(e => e.shrine.includes('ç¥å®®')) },
        { id: 's_ten', name: 'å­¦å•ã®ç¥æ§˜', icon: 'ğŸ“–', desc: 'ã€Œå¤©æº€å®®ã€ã¸è¡Œã', rank: 1, check: (d) => d.some(e => e.shrine.includes('å¤©æº€å®®')) },
        { id: 's_inari', name: 'ãŠç¨²è·ã•ã‚“', icon: 'ğŸ¦Š', desc: 'ã€Œç¨²è·ã€ã¸è¡Œã', rank: 1, check: (d) => d.some(e => e.shrine.includes('ç¨²è·')) },
        { id: 's_hachi', name: 'å…«å¹¡å®®ã®åŠ è­·', icon: 'âš”ï¸', desc: 'ã€Œå…«å¹¡ã€ã¸è¡Œã', rank: 1, check: (d) => d.some(e => e.shrine.includes('å…«å¹¡')) },
        { id: 'writer', name: 'æ–‡è±ª', icon: 'ğŸ–‹ï¸', desc: 'é•·ã„ãƒ¡ãƒ¢ã‚’æ›¸ã', rank: 1, check: (d) => d.some(e => e.note && e.note.length >= 50) },
        { id: 'friend', name: 'ä»£ç­†è€…', icon: 'âœï¸', desc: 'è‡ªåˆ†ä»¥å¤–ã‚’è¨˜éŒ²', rank: 1, check: (d) => d.some(e => e.name !== 'è‡ªåˆ†') },
        { id: 'party', name: 'è³‘ã‚„ã‹ãªå‚æ‹', icon: 'ğŸ‰', desc: '3äººä»¥ä¸Šã®åå‰', rank: 2, check: (d) => new Set(d.map(e => e.name)).size >= 3 },
        { id: 'master', name: 'å¾¡ç¥ç±¤ã®ç¥', icon: 'ğŸ’', desc: 'ä»–å…¨ç§°å·ç²å¾—', rank: 4, check: (d) => { 
            const others = BADGES.filter(b => b.id !== 'master'); 
            return others.every(b => b.check(d)); 
        }}
    ];

    window.onload = () => {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) entries = JSON.parse(stored);
        document.getElementById('input-date').valueAsDate = new Date();
        updateUI(); updateStreak(); renderBadges();
    };

    function switchTab(t) {
        document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
        document.getElementById('tab-'+t).classList.remove('hidden');
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        const tabs = document.querySelectorAll('.tab');
        const map = {'input':0, 'history':1, 'analysis':2, 'collection':3, 'settings':4};
        tabs[map[t]].classList.add('active');
        if(t === 'analysis') {
            updatePersonFilter(); // ãƒ•ã‚£ãƒ«ã‚¿æ›´æ–°
            updateChart();
        }
    }

    function addEntry() {
        const name = document.getElementById('input-name').value.trim();
        const shrine = document.getElementById('input-shrine').value.trim();
        if(!name || !shrine) return alert('åå‰ã¨ç¥ç¤¾åã‚’å…¥ã‚Œã¦ã­ï¼');
        entries.unshift({
            id: Date.now(), name, shrine,
            date: document.getElementById('input-date').value,
            result: document.getElementById('input-result').value,
            note: document.getElementById('input-note').value
        });
        saveData();
        document.getElementById('input-shrine').value = '';
        document.getElementById('input-note').value = '';
        switchTab('history');
    }

    function deleteEntry(id) {
        if(confirm('ã“ã®è¨˜éŒ²ã‚’æ¶ˆã—ã¦ã‚‚ã„ã„ï¼Ÿ')) {
            entries = entries.filter(e => e.id !== id);
            saveData();
        }
    }

    function saveData() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
        updateUI(); updateStreak(); renderBadges();
    }

    function updateStreak() {
        if(entries.length === 0) return;
        const dates = [...new Set(entries.map(e => e.date))].sort((a,b) => new Date(b) - new Date(a));
        let streak = 1;
        for(let i=0; i<dates.length-1; i++) {
            const diff = (new Date(dates[i]) - new Date(dates[i+1])) / 86400000;
            if(Math.round(diff) === 1) streak++; else break;
        }
        document.getElementById('streak-days').textContent = streak;
    }

    function updateUI() {
        // --- å…¥åŠ›å€™è£œæ›´æ–° ---
        updateDatalist('name-list', entries.map(e => e.name));
        updateDatalist('shrine-list', entries.map(e => e.shrine));

        // --- å±¥æ­´æ›´æ–° ---
        const list = document.getElementById('history-list');
        list.innerHTML = '';
        entries.forEach(e => {
            const div = document.createElement('div');
            div.className = 'history-item';
            div.innerHTML = `
                <div class="history-top">
                    <div><h3 style="margin:0;">${e.shrine}</h3><small style="color:var(--text-sub);">${e.date} | ${e.name}</small></div>
                    <div class="fortune-badge rank-dai-kichi" style="border-color:${getRankColor(e.result)}; color:${getRankColor(e.result)}; background:var(--card-bg);">${e.result}</div>
                </div>
                ${e.note ? `<div style="font-size:13px; margin-top:6px; color:var(--text-sub);">ğŸ“ ${e.note}</div>` : ''}
                <div class="action-row">
                    <button class="btn-small" onclick="shareText(${e.id})">ğŸ“¤ ã‚·ã‚§ã‚¢</button>
                    <button class="btn-small btn-goshuin" onclick="openGoshuinModal(${e.id})">ğŸ“¿ å¾¡æœ±å°</button>
                    <button class="btn-small btn-delete" onclick="deleteEntry(${e.id})">ğŸ—‘ï¸ å‰Šé™¤</button>
                </div>
            `;
            list.appendChild(div);
        });
    }

    function updateDatalist(id, values) {
        const list = document.getElementById(id);
        list.innerHTML = '';
        [...new Set(values)].sort().forEach(v => {
            const o = document.createElement('option'); o.value = v; list.appendChild(o);
        });
    }

    function getRankColor(r) {
        if(r.includes('å¤§å‰')) return '#D32F2F';
        if(r.includes('å‰')) return '#E65100';
        if(r.includes('å‡¶')) return '#5856D6';
        return '#333';
    }

    // --- ã‚·ã‚§ã‚¢æ©Ÿèƒ½ ---
    function shareText(id) {
        const e = entries.find(x => x.id === id);
        if(!e) return;
        const text = `â›©ï¸ ãŠã¿ãã˜çµæœ\n${e.date} ${e.shrine}\né‹å‹¢: ã€${e.result}ã€‘\n\n#ãŠã¿ãã˜ç®¡ç†`;
        if(navigator.share) {
            navigator.share({ title: 'ãŠã¿ãã˜', text: text }).catch(console.error);
        } else {
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`, '_blank');
        }
    }

    // --- å¾¡æœ±å°ãƒ­ã‚¸ãƒƒã‚¯ ---
    function openGoshuinModal(id) {
        currentGoshuinEntry = entries.find(e => e.id === id);
        document.getElementById('goshuin-modal').classList.add('show');
        
        // ãƒ•ã‚©ãƒ³ãƒˆèª­ã¿è¾¼ã¿å¾…æ©Ÿã¨æç”»
        const fontName = 'GoshuinFont';
        document.fonts.load(`1em "${fontName}"`).then(() => {
            drawGoshuin(currentGoshuinEntry);
        }).catch(() => {
            console.log('Font load fallback');
            drawGoshuin(currentGoshuinEntry);
        });
        drawGoshuin(currentGoshuinEntry);
    }

    function redrawGoshuin() { drawGoshuin(currentGoshuinEntry); }

    function drawGoshuin(e) {
        if(!e) return;
        const canvas = document.getElementById('goshuin-canvas');
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;

        ctx.fillStyle = "#fffcf2"; ctx.fillRect(0,0,width,height);
        ctx.strokeStyle = "#e60033"; ctx.lineWidth = 4; ctx.strokeRect(10,10,width-20,height-20);
        
        // ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š
        const fontBase = "'GoshuinFont', 'Shippori Mincho', 'Hiragino Mincho ProN', serif";

        // æœ±å°
        ctx.beginPath(); ctx.arc(width/2, height/2+20, 80, 0, Math.PI*2);
        ctx.strokeStyle = "rgba(230,0,51,0.15)"; ctx.lineWidth = 6; ctx.stroke();
        ctx.fillStyle = "rgba(230,0,51,0.15)"; ctx.font = `80px ${fontBase}`;
        ctx.textAlign = "center"; ctx.textBaseline = "middle";
        ctx.fillText("ç¥ç’½", width/2, height/2+20);

        // æ–‡å­—
        ctx.fillStyle = "#111"; ctx.textAlign = "center"; ctx.textBaseline = "top";
        
        // å¥‰æ‹
        ctx.font = `30px ${fontBase}`;
        drawVertical(ctx, "å¥‰æ‹", width-60, 60, 35);

        // ç¥ç¤¾å
        ctx.font = `50px ${fontBase}`;
        const sName = e.shrine;
        const startY = (height - (sName.length * 55)) / 2;
        drawVertical(ctx, sName, width/2, startY, 55);

        // æ—¥ä»˜
        ctx.font = `20px ${fontBase}`;
        const d = new Date(e.date);
        const dateStr = `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
        drawVertical(ctx, dateStr, 60, 100, 25);

        // é‹å‹¢å°
        ctx.save();
        ctx.translate(40, height-100); ctx.rotate(-0.1);
        ctx.strokeStyle = "#d60000"; ctx.lineWidth=3; ctx.strokeRect(-35,-35,70,70);
        ctx.fillStyle = "#d60000"; ctx.font = `24px ${fontBase}`; 
        ctx.textBaseline = "middle"; ctx.fillText(e.result, 0, 0);
        ctx.restore();
    }

    function drawVertical(ctx, text, x, y, lh) {
        for(let i=0; i<text.length; i++) ctx.fillText(text[i], x, y + i*lh);
    }

    function downloadGoshuin() {
        const c = document.getElementById('goshuin-canvas');
        const a = document.createElement('a'); a.download = `goshuin_${Date.now()}.png`; a.href = c.toDataURL(); a.click();
    }

    async function shareImage() {
        const canvas = document.getElementById('goshuin-canvas');
        canvas.toBlob(async (blob) => {
            if (!blob) return;
            const file = new File([blob], "goshuin.png", { type: "image/png" });
            if (navigator.share && navigator.canShare({ files: [file] })) {
                try { await navigator.share({ files: [file], title: 'å¾¡æœ±å°', text: 'ä»Šå›ã®ãŠã¿ãã˜çµæœï¼' }); } 
                catch (err) { console.error(err); }
            } else {
                alert('ã“ã®ç’°å¢ƒã§ã¯ç”»åƒã‚·ã‚§ã‚¢ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚ä¿å­˜ã—ã¦æŠ•ç¨¿ã—ã¦ãã ã•ã„ã€‚');
            }
        });
    }

    // --- ãã®ä»– ---
    function hasConsecutiveDays(data, days) {
        if(data.length < days) return false;
        const dates = [...new Set(data.map(e => e.date))].sort();
        let c = 1;
        for(let i=1; i<dates.length; i++) {
            if( (new Date(dates[i]) - new Date(dates[i-1]))/86400000 === 1 ) c++; else c=1;
            if(c >= days) return true;
        }
        return false;
    }
    function hasConsecutiveResult(data, targets, count) {
        if(data.length < count) return false;
        const s = [...data].sort((a,b)=>new Date(a.date)-new Date(b.date));
        let c = 0;
        for(let i=0; i<s.length; i++) {
            if(targets.includes(s[i].result)) c++; else c=0;
            if(c >= count) return true;
        }
        return false;
    }

    function renderBadges() {
        const c = document.getElementById('badge-container'); c.innerHTML = '';
        BADGES.forEach(b => {
            const div = document.createElement('div');
            const unlocked = b.check(entries);
            div.className = `badge-item badge-rank-${b.rank} ${unlocked ? 'unlocked' : ''}`;
            div.innerHTML = `<div style="font-size:28px;">${b.icon}</div><div style="font-size:10px; font-weight:bold; line-height:1.2;">${b.name}</div><div style="font-size:9px; margin-top:2px;">${b.desc}</div>`;
            c.appendChild(div);
        });
    }

    // --- åˆ†ææ©Ÿèƒ½ï¼ˆå®Œå…¨å¾©æ—§ï¼‰ ---
    function switchChartType(type) {
        currentChartType = type;
        document.getElementById('toggle-luck').classList.remove('active');
        document.getElementById('toggle-shrine').classList.remove('active');
        if (type === 'luck') document.getElementById('toggle-luck').classList.add('active'); 
        else document.getElementById('toggle-shrine').classList.add('active');
        updateChart();
    }

    function updatePersonFilter() {
        const sel = document.getElementById('filter-person');
        const val = sel.value;
        while(sel.options.length > 1) sel.remove(1);
        const names = [...new Set(entries.map(e => e.name))].sort();
        names.forEach(n => { const o = document.createElement('option'); o.value = n; o.textContent = n; sel.appendChild(o); });
        if(names.includes(val)) sel.value = val;
    }

    function updateChart() {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if (myChart) myChart.destroy();

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        const person = document.getElementById('filter-person').value;
        let filtered = entries;
        if(person !== 'ALL') filtered = entries.filter(e => e.name === person);

        // ãƒãƒ£ãƒ¼ãƒˆç”Ÿæˆ
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const txtColor = isDark ? '#fff' : '#000';

        if (currentChartType === 'luck') {
            // æ¨ªæ£’ã‚°ãƒ©ãƒ•ï¼ˆé‹å‹¢ï¼‰
            const lucks = ['å¤§å‰', 'å‰', 'ä¸­å‰', 'å°å‰', 'æœ«å‰', 'å‡¶', 'å¤§å‡¶'];
            const counts = lucks.map(l => filtered.filter(e => e.result === l).length);
            
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: lucks,
                    datasets: [{
                        label: 'å›æ•°',
                        data: counts,
                        backgroundColor: ['#FF3B30', '#FF9500', '#FFCC00', '#34C759', '#5AC8FA', '#5856D6', '#000'],
                        barPercentage: 0.6
                    }]
                },
                options: {
                    indexAxis: 'y', // æ¨ªæ£’ã«ã™ã‚‹
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { color: txtColor, precision:0 } },
                        y: { ticks: { color: txtColor, font:{weight:'bold'} } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        } else {
            // æ¨ªæ£’ã‚°ãƒ©ãƒ•ï¼ˆç¥ç¤¾ï¼‰
            const sCounts = {}; filtered.forEach(e => { sCounts[e.shrine] = (sCounts[e.shrine] || 0) + 1; });
            const sorted = Object.keys(sCounts).sort((a,b) => sCounts[b] - sCounts[a]).slice(0, 10); // Top 10
            
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted,
                    datasets: [{
                        label: 'å‚æ‹å›æ•°',
                        data: sorted.map(s => sCounts[s]),
                        backgroundColor: '#FF3B30',
                        barPercentage: 0.6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { color: txtColor, precision:0 } },
                        y: { ticks: { color: txtColor, font:{weight:'bold'} } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
        document.getElementById('analysis-summary').textContent = `å¯¾è±¡ãƒ‡ãƒ¼ã‚¿: ${filtered.length}ä»¶`;
    }

    // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
    function exportData() {
        const blob = new Blob([JSON.stringify(entries, null, 2)], {type: "application/json"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `omikuji_backup.json`; a.click();
    }
    function triggerImport() { document.getElementById('file-import').click(); }
    function importData(input) {
        const file = input.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const d = JSON.parse(e.target.result);
                if(Array.isArray(d)) {
                    if(confirm('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¦å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ')) {
                        entries = d; saveData(); alert('å¾©å…ƒã—ã¾ã—ãŸï¼');
                    }
                }
            } catch(err) { alert('ãƒ•ã‚¡ã‚¤ãƒ«ãŒå£Šã‚Œã¦ã„ã‚‹ã‹å½¢å¼ãŒé•ã„ã¾ã™'); }
        };
        reader.readAsText(file);
        input.value = '';
    }
    function clearAllData() { if(confirm('æœ¬å½“ã«å…¨éƒ¨æ¶ˆã™ï¼Ÿ')) { entries=[]; saveData(); } }
    function toggleTheme() {
        const c = document.documentElement.getAttribute('data-theme');
        document.documentElement.setAttribute('data-theme', c === 'dark' ? 'light' : 'dark');
        updateChart();
    }
    function closeModal() { document.getElementById('goshuin-modal').classList.remove('show'); }
</script>
</body>
</html>
