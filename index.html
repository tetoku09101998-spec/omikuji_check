<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ãŠã¿ãã˜ç®¡ç†</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ãŠã¿ãã˜">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#F2F2F7" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">

    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23FF3B30'/%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle' fill='white'%3Eâ›©ï¸%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23FF3B30'/%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle' fill='white'%3Eâ›©ï¸%3C/text%3E%3C/svg%3E">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@500;700&display=swap" rel="stylesheet">
    <style>
        /* --- é…è‰²è¨­å®š --- */
        :root {
            --primary: #007AFF; --bg: #F2F2F7; --card-bg: #FFFFFF;
            --input-bg: #EFEFF4; --input-border: #C7C7CC;
            --text: #000000; --text-sub: #333333; --danger: #FF3B30;
            --gold: #FFD700; --silver: #C0C0C0; --bronze: #CD7F32;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        /* --- ä¸­æ£®å·¥èŠ¸ãƒ•ã‚©ãƒ³ãƒˆ --- */
        @font-face {
            font-family: 'GoshuinFont';
            src: url('TTEdit1ã€€aaaä¸­æ£®å·¥èŠ¸ï¼’ï¼ï¼‘ï¼˜1212.ttf') format('truetype');
        }

        [data-theme="dark"] {
            --primary: #0A84FF; --bg: #000000; --card-bg: #1C1C1E;
            --input-bg: #3A3A3C; --input-border: #636366; --text: #FFFFFF; --text-sub: #D1D1D6;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif; margin: 0; padding: 0;
            background-color: var(--bg); color: var(--text); font-size: 15px;
            padding-top: var(--safe-top); padding-bottom: calc(80px + var(--safe-bottom));
            overscroll-behavior-y: none;
        }

        header {
            background: var(--card-bg); padding: 12px 16px; position: sticky; top: 0;
            z-index: 100; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--input-border); height: 44px;
        }

        h1 { font-size: 17px; margin: 0; font-weight: 700; }
        .version-badge { font-size: 10px; background: var(--input-bg); padding: 2px 6px; border-radius: 4px; color: var(--text-sub); margin-left: 8px; vertical-align: middle; }

        .streak-container {
            background: linear-gradient(135deg, #FF9500 0%, #FF3B30 100%);
            color: white; padding: 12px; border-radius: 12px; margin: 10px 16px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .streak-count { font-size: 24px; font-weight: 800; }

        .container { width: 100%; padding: 0; }
        .card { background: var(--card-bg); padding: 16px; margin-bottom: 12px; border-bottom: 1px solid var(--input-border); }
        .form-group { margin-bottom: 16px; }
        label { display: block; font-size: 13px; font-weight: 700; color: var(--text-sub); margin-bottom: 6px; }

        /* å…¥åŠ›ã‚¹ã‚¿ã‚¤ãƒ« */
        input[type="text"], input[type="date"], select, textarea {
            width: 100%; padding: 12px; font-size: 16px; font-weight: 500;
            border: 1px solid var(--input-border); border-radius: 8px; box-sizing: border-box;
            background: var(--input-bg); color: var(--text); outline: none;
        }
        select {
            -webkit-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat; background-position: right 12px center; background-size: 14px;
        }

        button.btn-primary {
            display: block; width: 92%; margin: 10px auto; padding: 14px;
            background: var(--primary); color: white; border: none; border-radius: 10px;
            font-size: 16px; font-weight: 700; cursor: pointer;
        }

        .tabs { display: flex; background: var(--card-bg); padding: 8px; border-bottom: 1px solid var(--input-border); position: sticky; top: 68px; z-index: 90; }
        .tab { flex: 1; text-align: center; padding: 10px 4px; font-size: 13px; cursor: pointer; border-radius: 8px; color: var(--text-sub); font-weight: 700; }
        .tab.active { background: var(--bg); color: var(--primary); }

        .history-item { background: var(--card-bg); padding: 16px; border-bottom: 1px solid var(--input-border); margin-bottom: 1px; }
        .history-top { display: flex; justify-content: space-between; align-items: flex-start; }
        .fortune-badge { font-size: 14px; padding: 4px 12px; border-radius: 6px; font-weight: 700; border: 1px solid; }

        .badge-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; padding: 10px; }
        .badge-item { background: var(--card-bg); border: 2px solid var(--input-border); border-radius: 12px; padding: 12px; text-align: center; opacity: 0.3; filter: grayscale(100%); }
        .badge-item.unlocked { opacity: 1; filter: grayscale(0%); border-color: var(--bronze); }
        .badge-rank-4.unlocked { border-color: var(--primary); box-shadow: 0 0 10px var(--primary); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-overlay.show { display: flex; }
        .modal-content { background: var(--card-bg); width: 90%; max-width: 400px; border-radius: 20px; padding: 20px; text-align: center; }
        .goshuin-preview { width: 100%; border-radius: 10px; margin-bottom: 15px; border: 1px solid #ccc; }
        .hidden { display: none; }
        .action-row { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }
        .btn-small { padding: 6px 12px; font-size: 12px; border-radius: 4px; border: none; background: var(--input-bg); color: var(--text); }
        .rank-dai-kichi { color: #D32F2F; background: #FFEBEE; border-color: #D32F2F; }
    </style>
</head>
<body>

<header>
    <h1>â›©ï¸ ãŠã¿ãã˜<span class="version-badge">ver 3.8</span></h1>
    <button onclick="toggleTheme()" style="background:none; border:none; font-size:20px;">ğŸŒ—</button>
</header>

<div class="container">
    <div class="tabs">
        <div class="tab active" onclick="switchTab('input')">ğŸ–Šï¸ è¨˜éŒ²</div>
        <div class="tab" onclick="switchTab('history')">ğŸ“œ å±¥æ­´</div>
        <div class="tab" onclick="switchTab('analysis')">ğŸ“Š åˆ†æ</div>
        <div class="tab" onclick="switchTab('collection')">ğŸ† ç§°å·</div>
    </div>

    <div id="tab-input">
        <div class="streak-container">
            <div style="font-size:24px;">ğŸ”¥</div>
            <div>
                <div class="streak-count"><span id="streak-days">0</span>æ—¥</div>
                <div style="font-size:11px; font-weight:bold;">é€£ç¶šå‚æ‹ä¸­</div>
            </div>
        </div>
        <div class="card">
            <div class="form-group">
                <label>ğŸ‘¤ åå‰</label>
                <input type="text" id="input-name" placeholder="ä¾‹: è‡ªåˆ†" list="name-list" autocomplete="off">
                <datalist id="name-list"></datalist>
            </div>
            <div class="form-group">
                <label>ğŸ“… å‚æ‹æ—¥</label>
                <input type="date" id="input-date">
            </div>
            <div class="form-group">
                <label>â›©ï¸ ç¥ç¤¾å</label>
                <input type="text" id="input-shrine" placeholder="ä¾‹: æ˜æ²»ç¥å®®" list="shrine-list" autocomplete="off">
                <datalist id="shrine-list"></datalist>
            </div>
            <div class="form-group">
                <label>ğŸ”® é‹å‹¢</label>
                <select id="input-result">
                    <option value="å¤§å‰">å¤§å‰</option><option value="å‰">å‰</option><option value="ä¸­å‰">ä¸­å‰</option>
                    <option value="å°å‰">å°å‰</option><option value="æœ«å‰">æœ«å‰</option><option value="å‡¶">å‡¶</option><option value="å¤§å‡¶">å¤§å‡¶</option>
                </select>
            </div>
            <div class="form-group"><label>ğŸ“ ãƒ¡ãƒ¢</label><textarea id="input-note" rows="2"></textarea></div>
        </div>
        <button class="btn-primary" onclick="addEntry()">ğŸ’¾ è¨˜éŒ²ã‚’ä¿å­˜ï¼</button>
    </div>

    <div id="tab-history" class="hidden">
        <div id="history-list"></div>
    </div>

    <div id="tab-analysis" class="hidden">
        <div class="card"><canvas id="mainChart"></canvas></div>
    </div>

    <div id="tab-collection" class="hidden">
        <div id="badge-container" class="badge-list"></div>
    </div>
</div>

<div id="goshuin-modal" class="modal-overlay" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <canvas id="goshuin-canvas" width="300" height="450" class="goshuin-preview"></canvas>
        <div style="display:flex; justify-content:center; gap:10px;">
            <button class="btn-primary" style="width:auto; margin:0;" onclick="downloadGoshuin()">ä¿å­˜</button>
            <button class="btn-primary" style="width:auto; background:#888; margin:0;" onclick="redrawGoshuin()">å†æç”»</button>
        </div>
    </div>
</div>

<script>
    const STORAGE_KEY = 'omikuji_app_data_v1';
    let entries = [];
    let currentGoshuinEntry = null;

    // --- ç§°å·ãƒ‡ãƒ¼ã‚¿ ---
    const BADGES = [
        { id: 'f1', name: 'åˆã‚ã®ä¸€æ­©', icon: 'ğŸ£', desc: 'åˆã‚ã¦è¨˜éŒ²ã—ãŸ', rank: 1, check: (d) => d.length >= 1 },
        { id: 'f10', name: 'å‚æ‹æ„›å¥½å®¶', icon: 'ğŸš¶', desc: 'è¨˜éŒ²ãŒ10å›', rank: 1, check: (d) => d.length >= 10 },
        { id: 'f50', name: 'ç¥ã®ä½¿ã„', icon: 'ğŸ§š', desc: 'è¨˜éŒ²ãŒ50å›', rank: 3, check: (d) => d.length >= 50 },
        { id: 'f100', name: 'ç”Ÿãã‚‹ä¼èª¬', icon: 'ğŸ²', desc: 'è¨˜éŒ²ãŒ100å›', rank: 4, check: (d) => d.length >= 100 },
        { id: 'lucky3', name: 'ç¢ºå¤‰ãƒ¢ãƒ¼ãƒ‰', icon: 'ğŸ°', desc: '3å›é€£ç¶šã§å¤§å‰', rank: 3, check: (d) => {
            if(d.length < 3) return false;
            const s = [...d].sort((a,b)=>new Date(b.date)-new Date(a.date));
            return s[0].result==='å¤§å‰'&&s[1].result==='å¤§å‰'&&s[2].result==='å¤§å‰';
        }}
    ];

    window.onload = () => {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) entries = JSON.parse(stored);
        document.getElementById('input-date').valueAsDate = new Date();
        updateUI(); updateStreak(); renderBadges();
    };

    function switchTab(t) {
        document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
        document.getElementById('tab-'+t).classList.remove('hidden');
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        const tabs = document.querySelectorAll('.tab');
        const map = {'input':0, 'history':1, 'analysis':2, 'collection':3};
        tabs[map[t]].classList.add('active');
        if(t === 'analysis') updateChart();
    }

    function addEntry() {
        const name = document.getElementById('input-name').value.trim();
        const shrine = document.getElementById('input-shrine').value.trim();
        if(!name || !shrine) return alert('åå‰ã¨ç¥ç¤¾åã‚’å…¥ã‚Œã¦ã­ï¼');
        entries.unshift({
            id: Date.now(), name, shrine,
            date: document.getElementById('input-date').value,
            result: document.getElementById('input-result').value,
            note: document.getElementById('input-note').value
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
        document.getElementById('input-shrine').value = '';
        updateUI(); updateStreak(); renderBadges();
        switchTab('history');
    }

    function deleteEntry(id) {
        if(confirm('ã“ã®è¨˜éŒ²ã‚’æ¶ˆã—ã¦ã‚‚ã„ã„ï¼Ÿ')) {
            entries = entries.filter(e => e.id !== id);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
            updateUI(); updateStreak(); renderBadges();
        }
    }

    function updateStreak() {
        if(entries.length === 0) return;
        const dates = [...new Set(entries.map(e => e.date))].sort((a,b) => new Date(b) - new Date(a));
        let streak = 1;
        for(let i=0; i<dates.length-1; i++) {
            const diff = (new Date(dates[i]) - new Date(dates[i+1])) / 86400000;
            if(Math.round(diff) === 1) streak++; else break;
        }
        document.getElementById('streak-days').textContent = streak;
    }

    function updateUI() {
        // å…¥åŠ›å€™è£œã®æ›´æ–°
        const names = [...new Set(entries.map(e => e.name))].sort();
        const nList = document.getElementById('name-list');
        nList.innerHTML = ''; names.forEach(n => { const o = document.createElement('option'); o.value = n; nList.appendChild(o); });
        const shrines = [...new Set(entries.map(e => e.shrine))].sort();
        const sList = document.getElementById('shrine-list');
        sList.innerHTML = ''; shrines.forEach(s => { const o = document.createElement('option'); o.value = s; sList.appendChild(o); });

        // å±¥æ­´ãƒªã‚¹ãƒˆã®æ›´æ–°
        const list = document.getElementById('history-list');
        list.innerHTML = '';
        entries.forEach(e => {
            const div = document.createElement('div');
            div.className = 'history-item';
            div.innerHTML = `
                <div class="history-top">
                    <div><h3 style="margin:0;">${e.shrine}</h3><small>${e.date} | ${e.name}</small></div>
                    <div class="fortune-badge rank-dai-kichi">${e.result}</div>
                </div>
                <div class="action-row">
                    <button class="btn-small" onclick="openGoshuinModal(${e.id})">ğŸ“¿ å¾¡æœ±å°</button>
                    <button class="btn-small" style="color:var(--danger);" onclick="deleteEntry(${e.id})">ğŸ—‘ï¸ å‰Šé™¤</button>
                </div>
            `;
            list.appendChild(div);
        });
    }

    function openGoshuinModal(id) {
        currentGoshuinEntry = entries.find(e => e.id === id);
        document.getElementById('goshuin-modal').classList.add('show');
        document.fonts.load('1em "GoshuinFont"').then(() => drawGoshuin(currentGoshuinEntry));
    }

    function redrawGoshuin() { drawGoshuin(currentGoshuinEntry); }

    function drawGoshuin(e) {
        const canvas = document.getElementById('goshuin-canvas');
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = "#fffcf2"; ctx.fillRect(0,0,300,450);
        ctx.strokeStyle = "#e60033"; ctx.lineWidth = 4; ctx.strokeRect(10,10,280,430);
        ctx.fillStyle = "rgba(230,0,51,0.15)"; ctx.font = "80px GoshuinFont"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
        ctx.fillText("ç¥ç’½", 150, 225);
        ctx.fillStyle = "#111"; ctx.font = "45px GoshuinFont"; ctx.textBaseline = "top";
        const s = e.shrine; for(let i=0; i<s.length; i++) ctx.fillText(s[i], 150, 60 + i*50);
        ctx.font = "24px GoshuinFont"; ctx.fillText("å¥‰æ‹", 250, 40);
        ctx.font = "18px GoshuinFont"; ctx.fillText(e.date.replace(/-/g,'.'), 50, 40);
        ctx.strokeStyle = "#d60000"; ctx.lineWidth = 2; ctx.strokeRect(30, 360, 60, 60);
        ctx.fillStyle = "#d60000"; ctx.font = "30px GoshuinFont"; ctx.textBaseline = "middle";
        ctx.fillText(e.result.substring(0,2), 60, 390);
    }

    function downloadGoshuin() {
        const c = document.getElementById('goshuin-canvas');
        const a = document.createElement('a'); a.download = 'goshuin.png'; a.href = c.toDataURL(); a.click();
    }

    function renderBadges() {
        const container = document.getElementById('badge-container');
        container.innerHTML = '';
        BADGES.forEach(b => {
            const div = document.createElement('div');
            div.className = `badge-item badge-rank-${b.rank} ${b.check(entries) ? 'unlocked' : ''}`;
            div.innerHTML = `<div style="font-size:32px;">${b.icon}</div><div style="font-size:12px; font-weight:bold;">${b.name}</div>`;
            container.appendChild(div);
        });
    }

    function updateChart() {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if (myChart) myChart.destroy();
        const counts = {}; entries.forEach(e => { counts[e.result] = (counts[e.result] || 0) + 1; });
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: Object.keys(counts), datasets: [{ data: Object.values(counts), backgroundColor: ['#FF3B30', '#FF9500', '#FFCC00', '#34C759', '#007AFF'] }] },
            options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });
    }

    function toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme');
        document.documentElement.setAttribute('data-theme', current === 'dark' ? 'light' : 'dark');
    }
    function closeModal() { document.getElementById('goshuin-modal').classList.remove('show'); }
</script>
</body>
</html>
